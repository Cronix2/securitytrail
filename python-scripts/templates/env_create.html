<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Créer un fichier .env</title>
    <link rel="stylesheet" href="../static/style.css">
    <style>
        html, body {
            height: 100vh;
            margin: 0;
            background: #121212;
            color: #ffffff;
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .container {
            background: #161b22;
            padding: 20px;
            margin:auto;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
            width: 400px;
            text-align: center;
            border: 1px solid #30363d;
        }

        h1 {
            font-size: 22px;
            margin-bottom: 20px;
        }

        form {
            display: flex;
            flex-direction: column;
        }

        label {
            margin: 5px 0;
            font-weight: bold;
            text-align: left;
        }

        /* input {
            background: #0d1117;
            color: #c9d1d9;
            border: 0px solid;
        } */

        button {
            background: #238636;
            color: white;
            border: none;
            padding: 12px;
            cursor: pointer;
            border-radius: 4px;
            font-size: 16px;
            margin-top: 10px;
        }

        button:hover {
            background: #2ea043;
        }

        .button_title {
            margin: 0;
            font: inherit;
            font-size: large;
        }

        .env-box {
            border: 1px dashed #30363d;
            padding: 15px;
            margin-top: 20px;
            background: #161b22;
            cursor: pointer;
        }

        .env-box.drag-over {
            background: rgba(255, 255, 255, 0.1); /* Effet de filtre blanc semi-transparent */
            border: 1px dashed #ffffff; /* Bordure plus visible */
            transition: all 0.3s ease-in-out;
        }

        .custum-file-upload .icon {
            display: flex;
            align-items: center;
            justify-content: center;
            margin: auto;
        }

        .custum-file-upload .icon svg {
            height: 80px;
            fill: #e8e8e8;
        }

        .upload_strong {
            font-size: 16px;
            font-weight: bold;
            margin-top: 10px;
        }

        .upload_small {
            font-size: 14px;
            color: #aab1b8;
            margin-top: 5px;
        }

        .input-error {
            border: 2px solid red !important;
            box-shadow: 0 0 10px rgba(255, 0, 0, 0.5);
            animation: shake 0.3s;
            animation-iteration-count: 1;
        }

        /* .input-container {
            position: relative;
            display: flex;
            align-items: center;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #30363d;
            border-radius: 4px;
            background: #0d1117;
            color: #c9d1d9;
        } */

        .input-container {
            position: relative;
            display: flex;
            align-items: center;
            width: 100%;
            margin-bottom: 10px;
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 4px;
            padding: 5px;
        }

        .input-container input {
            flex: 1;
            background: transparent;
            border: none;
            padding: 10px;
            color: #c9d1d9;
            font-size: 14px;
            outline: none;
            width: 100%;
        }

        .input-container input::placeholder {
            color: rgba(255, 255, 255, 0.5);
            filter: blur(3px);
            transition: filter 0.3s ease-in-out, color 0.3s ease-in-out;
        }

        .input-container input:focus::placeholder {
            filter: blur(0px);
            color: rgba(255, 255, 255, 0.8);
        }

        .eye-icon {
            position: absolute;
            right: 10px;
            cursor: pointer;
            width: 24px;
            height: 24px;
            stroke: white;
            transition: opacity 0.3s ease-in-out;
        }

        .eye-icon:hover {
            opacity: 0.7;
        }


        .error-message {
            color: red;
            font-size: 12px;
            margin-top: 3px;
            display: none;
        }

        .hidden-file-input {
            display: none;
        }

        .success-effect {
            border: 1px solid white !important;
            box-shadow: 0 0 30px rgba(34, 197, 94, 0.8) !important;
            transition: all 0.5s ease-in-out;
        }

    </style>
</head>
<body>
    <header class="navbar">
        <div class="nav-container">
            <a href="/" class="logo">Subdomain Finder</a>
            <nav class="nav-menu">
                <ul>
                    <li><a href="/">Logs</a></li>
                    <li><a href="/stats">Statistics</a></li>
                    <li><a href="/history">History</a></li>
                </ul>
            </nav>
        </div>
    </header>
    <main class="container" id="mainContainer">
        <h1>Create or modify .env file</h1>
        <form id="envForm">
            <label for="apiKey">API key:</label>
            <div class="input-container">
                <input type="password" id="apiKey" name="API_KEY" required>
                <svg id="toggleApiKey" class="eye-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M1 12C2.5 7 7 3.5 12 3.5C17 3.5 21.5 7 23 12C21.5 17 17 20.5 12 20.5C7 20.5 2.5 17 1 12Z" stroke="#ffffff" stroke-width="2"></path>
                    <circle cx="12" cy="12" r="3" stroke="#ffffff" stroke-width="2"></circle>
                </svg>
            </div>
            <p class="error-message"></p>


            <label for="dbUser">Username:</label>
            <div class="input-container">
                <input type="text" id="dbUser" name="DB_USER" required>
            </div>
            <p class="error-message"></p>

            <label for="dbPassword">Password:</label>
            <div class="input-container">
                <input type="password" id="dbPassword" name="DB_PASSWORD" required>
                <svg id="togglepassword" class="eye-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M1 12C2.5 7 7 3.5 12 3.5C17 3.5 21.5 7 23 12C21.5 17 17 20.5 12 20.5C7 20.5 2.5 17 1 12Z" stroke="#ffffff" stroke-width="2"></path>
                    <circle cx="12" cy="12" r="3" stroke="#ffffff" stroke-width="2"></circle>
                </svg>
            </div>
            <p class="error-message"></p>

            <label for="dbHost">Host:</label>
            <div class="input-container">
                <input type="text" id="dbHost" name="DB_HOST" required>
            </div>
            <p class="error-message"></p>

            <button type="button" onclick="generateEnvFile()"><p class="button_title">Generate</p></button>
        </form>
        <input type="file" id="fileInput" class="hidden-file-input" accept=".env">
        <div class="env-box" id="dropZone" onclick="document.getElementById('fileInput').click();">
            <label for="file" class="custum-file-upload">
                <div class="icon" id="fileStatusIcon">
                    <svg viewBox="0 0 24 24" fill="" xmlns="http://www.w3.org/2000/svg">
                        <g id="SVGRepo_bgCarrier" stroke-width="0"></g>
                        <g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g>
                        <g id="SVGRepo_iconCarrier"> 
                            <path fill-rule="evenodd" clip-rule="evenodd" d="M10 1C9.73478 1 9.48043 1.10536 9.29289 1.29289L3.29289 7.29289C3.10536 7.48043 3 7.73478 3 8V20C3 21.6569 4.34315 23 6 23H7C7.55228 23 8 22.5523 8 22C8 21.4477 7.55228 21 7 21H6C5.44772 21 5 20.5523 5 20V9H10C10.5523 9 11 8.55228 11 8V3H18C18.5523 3 19 3.44772 19 4V9C19 9.55228 19.4477 10 20 10C20.5523 10 21 9.55228 21 9V4C21 2.34315 19.6569 1 18 1H10ZM9 7H6.41421L9 4.41421V7ZM14 15.5C14 14.1193 15.1193 13 16.5 13C17.8807 13 19 14.1193 19 15.5V16V17H20C21.1046 17 22 17.8954 22 19C22 20.1046 21.1046 21 20 21H13C11.8954 21 11 20.1046 11 19C11 17.8954 11.8954 17 13 17H14V16V15.5ZM16.5 11C14.142 11 12.2076 12.8136 12.0156 15.122C10.2825 15.5606 9 17.1305 9 19C9 21.2091 10.7909 23 13 23H20C22.2091 23 24 21.2091 24 19C24 17.1305 22.7175 15.5606 20.9844 15.122C20.7924 12.8136 18.858 11 16.5 11Z" fill=""></path> 
                        </g>
                    </svg>
                </div>
            </label>
            <p class="upload_strong"><strong>Upload .env file</strong></p>
            <p class="upload_small">Drag and drop your .env file here or click to browse</p>
            <p class="error-message" id="errorMessage"></p
        </div>
    </main>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            fetch("/info-env")
                .then(response => {
                    if (!response.ok) {
                        throw new Error("Fichier .env introuvable");
                    }
                    return response.json();
                })
                .then(data => {
                    if (Array.isArray(data) && data.length > 0) {
                        const envValues = data[0]; // Récupérer le premier objet du tableau

                        // Vérifie si les clés existent et met à jour les placeholders
                        if (envValues.API_KEY) {
                            document.getElementById("apiKey").placeholder = envValues.API_KEY;
                        }
                        if (envValues.DB_USER) {
                            document.getElementById("dbUser").placeholder = envValues.DB_USER;
                        }
                        if (envValues.DB_PASSWORD) {
                            document.getElementById("dbPassword").placeholder = envValues.DB_PASSWORD;
                        }
                        if (envValues.DB_HOST) {
                            document.getElementById("dbHost").placeholder = envValues.DB_HOST;
                        }
                    }
                })
                .catch(error => {
                    console.warn("Impossible de récupérer le fichier .env :", error);
                });
        });

        document.getElementById("toggleApiKey").addEventListener("click", function () {
            const apiKeyInput = document.getElementById("apiKey");
            const eyeIcon = document.getElementById("toggleApiKey");

            if (apiKeyInput.type === "password") {
                apiKeyInput.type = "text"; // Montre la clé API
                eyeIcon.innerHTML = `
                    <path d="M1 12C2.5 7 7 3.5 12 3.5C17 3.5 21.5 7 23 12C21.5 17 17 20.5 12 20.5C7 20.5 2.5 17 1 12Z" stroke="#ffffff" stroke-width="2"></path>
                    <circle cx="12" cy="12" r="3" stroke="#ffffff" stroke-width="2"></circle>
                    <path d="M3 3L21 21" stroke="#ffffff" stroke-width="2"></path>
                `; // Icône barrée
            } else {
                apiKeyInput.type = "password"; // Cache la clé API
                eyeIcon.innerHTML = `
                    <path d="M1 12C2.5 7 7 3.5 12 3.5C17 3.5 21.5 7 23 12C21.5 17 17 20.5 12 20.5C7 20.5 2.5 17 1 12Z" stroke="#ffffff" stroke-width="2"></path>
                    <circle cx="12" cy="12" r="3" stroke="#ffffff" stroke-width="2"></circle>
                `; // Icône ouverte
            }
        });


        document.getElementById("togglepassword").addEventListener("click", function () {
            const PasswordInput = document.getElementById("dbPassword");
            const eyeIcon = document.getElementById("togglepassword");

            if (PasswordInput.type === "password") {
                PasswordInput.type = "text"; // Montre la clé API
                eyeIcon.innerHTML = `
                    <path d="M1 12C2.5 7 7 3.5 12 3.5C17 3.5 21.5 7 23 12C21.5 17 17 20.5 12 20.5C7 20.5 2.5 17 1 12Z" stroke="#ffffff" stroke-width="2"></path>
                    <circle cx="12" cy="12" r="3" stroke="#ffffff" stroke-width="2"></circle>
                    <path d="M3 3L21 21" stroke="#ffffff" stroke-width="2"></path>
                `; // Icône barrée
            } else {
                PasswordInput.type = "password"; // Cache la clé API
                eyeIcon.innerHTML = `
                    <path d="M1 12C2.5 7 7 3.5 12 3.5C17 3.5 21.5 7 23 12C21.5 17 17 20.5 12 20.5C7 20.5 2.5 17 1 12Z" stroke="#ffffff" stroke-width="2"></path>
                    <circle cx="12" cy="12" r="3" stroke="#ffffff" stroke-width="2"></circle>
                `; // Icône ouverte
            }
        });
        function generateEnvFile() {
            const apiKey = document.getElementById('apiKey');
            const dbUser = document.getElementById('dbUser');
            const dbPassword = document.getElementById('dbPassword');
            const dbHost = document.getElementById('dbHost');

            // Regex pour validation des champs
            const validRegex = /^[a-zA-Z0-9\s\-_,.@=]+$/;

            // Réinitialisation des erreurs
            let isValid = true;
            document.querySelectorAll('.error-message').forEach(el => el.style.display = 'none');
            document.querySelectorAll('.input-container').forEach(el => el.classList.remove('input-error'));

            // Fonction pour afficher un message d'erreur sous un champ et ajouter la bordure rouge
            function showError(input, message) {
                isValid = false;
                const inputContainer = input.parentElement; // Récupère le parent contenant l'input
                inputContainer.classList.add('input-error'); // Ajoute la classe de bordure rouge
                const errorElement = inputContainer.nextElementSibling; // L'erreur est sous le conteneur
                errorElement.textContent = message;
                errorElement.style.display = 'block';
            }

            // Vérification des champs avec regex et présence
            if (apiKey.value.trim() === "" || !validRegex.test(apiKey.value)) {
                showError(apiKey, "Seuls les caractères alphanumériques et spéciaux classiques sont autorisés.");
            }
            if (dbUser.value.trim() === "" || !validRegex.test(dbUser.value)) {
                showError(dbUser, "Seuls les caractères alphanumériques et spéciaux classiques sont autorisés.");
            }
            if (dbPassword.value.trim() === "" || !validRegex.test(dbPassword.value)) {
                showError(dbPassword, "Seuls les caractères alphanumériques et spéciaux classiques sont autorisés.");
            }
            if (dbHost.value.trim() === "" || !validRegex.test(dbHost.value)) {
                showError(dbHost, "Seuls les caractères alphanumériques et spéciaux classiques sont autorisés.");
            }

            // Si toutes les valeurs sont valides, on génère le fichier
            if (isValid) {
                const envContent = `API_KEY=\"${apiKey.value}\"\nDB_USER=\"${dbUser.value}\"\nDB_PASSWORD=\"${dbPassword.value}\"\nDB_HOST=\"${dbHost.value}\"`;

                const blob = new Blob([envContent], { type: 'text/plain' });
                const formData = new FormData();
                formData.append("env_file", blob, ".env");
                try {
                    sendFileToServer(formData.get("env_file"));
                } catch (error) {
                    console.error("Erreur lors de l'envoi du fichier : ", error);
                }
            }
        }


        

        function validateEnvFile(file) {
            const fileStatusIcon = document.getElementById('fileStatusIcon');
            const errorMessage = document.getElementById('errorMessage');
            fileStatusIcon.innerHTML = '';
            errorMessage.textContent = '';
            
            if (!file) {
                console.error("Aucun fichier fourni à validateEnvFile !");
                return;
            }

            // Renommer le fichier s'il n'est pas nommé correctement
            const renamedFile = new File([file], ".env", { type: file.type });
            file = renamedFile;
            
            const reader = new FileReader();
            reader.onload = function(event) {
                const lines = event.target.result.split("\n");
                if (lines.length !== 4) {
                    errorMessage.style.color = "red";
                    fileStatusIcon.innerHTML = '<svg viewBox="0 0 24 24" fill="red" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="10" stroke="red" stroke-width="2" fill="none" /><line x1="8" y1="8" x2="16" y2="16" stroke="red" stroke-width="2" /><line x1="16" y1="8" x2="8" y2="16" stroke="red" stroke-width="2" /></svg>';
                    errorMessage.textContent = "Le fichier doit contenir exactement 4 lignes.";
                    return;
                }
                const regex = /^[a-zA-Z0-9\s\-_,.=@"]+$/;
                const expectedKeys = ["API_KEY=", "DB_USER=", "DB_PASSWORD=", "DB_HOST="];
                for (let i = 0; i < 4; i++) {
                    if (!lines[i].startsWith(expectedKeys[i])){
                        errorMessage.style.color = "red";
                        fileStatusIcon.innerHTML = '<svg viewBox="0 0 24 24" fill="red" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="10" stroke="red" stroke-width="2" fill="none" /><line x1="8" y1="8" x2="16" y2="16" stroke="red" stroke-width="2" /><line x1="16" y1="8" x2="8" y2="16" stroke="red" stroke-width="2" /></svg>';
                        errorMessage.textContent = "Format incorrect à la ligne " + (i + 1) + " erreur 1";
                        return;
                    }
                    if (lines[i].length > 200){
                        errorMessage.style.color = "red";
                        fileStatusIcon.innerHTML = '<svg viewBox="0 0 24 24" fill="red" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="10" stroke="red" stroke-width="2" fill="none" /><line x1="8" y1="8" x2="16" y2="16" stroke="red" stroke-width="2" /><line x1="16" y1="8" x2="8" y2="16" stroke="red" stroke-width="2" /></svg>';
                        errorMessage.textContent = "Format incorrect à la ligne " + (i + 1) + " erreur 2";
                        return;
                    }
                    if (!regex.test(lines[i].substring(expectedKeys[i].length))) {
                        errorMessage.style.color = "red";
                        fileStatusIcon.innerHTML = '<svg viewBox="0 0 24 24" fill="red" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="10" stroke="red" stroke-width="2" fill="none" /><line x1="8" y1="8" x2="16" y2="16" stroke="red" stroke-width="2" /><line x1="16" y1="8" x2="8" y2="16" stroke="red" stroke-width="2" /></svg>';
                        errorMessage.textContent = "Format incorrect à la ligne " + (i + 1) + " erreur 3";
                        return;
                    }
                }
                sendFileToServer(file);
                fileStatusIcon.innerHTML = '<svg viewBox="0 0 24 24" fill="green" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="10" stroke="green" stroke-width="2" fill="none" /><path d="M8 12l3 3l5 -5" stroke="green" stroke-width="2" fill="none" /></svg>';
                errorMessage.textContent = "Fichier .env valide !";
                errorMessage.style.color = "green";
            };
            reader.readAsText(file);
        }



        document.getElementById('fileInput').addEventListener('change', function(event) {
            validateEnvFile(event.target.files[0]);
        });

        document.getElementById('dropZone').addEventListener('dragover', (event) => {
            event.preventDefault();
        });

        document.getElementById('dropZone').addEventListener('drop', (event) => {
            event.preventDefault();
            const file = event.dataTransfer.files[0];
            validateEnvFile(file);
        });

        function sendFileToServer(file) {
            const formData = new FormData();
            formData.append('file', file);

            console.log("Envoi du fichier : ", file.name);

            fetch('/upload-env', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                mainContainer.classList.add("success-effect");
                
                // Supprime l'effet après 3 secondes
                setTimeout(() => {
                    mainContainer.classList.remove("success-effect");
                }, 10000);
                console.log(data.message);
                document.getElementById('errorMessage').textContent = data.message;
            })
            .catch(error => console.error('Error:', error));
        }

        const dropZone = document.getElementById('dropZone');

        document.addEventListener('dragover', (event) => {
            event.preventDefault();
            dropZone.classList.add('drag-over'); // Ajoute l'effet dès qu'un fichier passe sur la page
        });

        document.addEventListener('dragleave', (event) => {
            // Vérifie si l'élément quitté est bien la page entière
            if (event.relatedTarget === null) {
                dropZone.classList.remove('drag-over'); // Retire l'effet quand on quitte la page
            }
        });

        document.addEventListener('drop', (event) => {
            event.preventDefault();
            dropZone.classList.remove('drag-over'); // Retire l'effet après le drop
            const file = event.dataTransfer.files[0];

            if (file) {
                validateEnvFile(file);
            }
        });

    </script>
</body>
</html>
